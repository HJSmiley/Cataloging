# 시스템 아키텍처 문서 (System Architecture Spec)

## 1. 전체 구성

카탈로깅 시스템은 마이크로서비스 아키텍처를 기반으로 설계되었으며, 프론트엔드(Flutter), 회원 API(Spring Boot), 카탈로그 API(FastAPI)로 구성됩니다.

### 1.1 시스템 구성도

```
┌─────────────────────────────────────────────────────────┐
│              Flutter Client (포트 3000)                  │
│  ┌──────────┐  ┌──────────┐  ┌──────────────────────┐  │
│  │ UI Layer │  │  State   │  │   API Service        │  │
│  │ (Screens)│  │  (GetX)  │  │   (HTTP Client)      │  │
│  └──────────┘  └──────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────┘
                        │
                        │ HTTP/JSON + JWT
                        ▼
┌─────────────────────────────────────────────────────────┐
│              개발: 직접 연결 / 프로덕션: ALB             │
│  라우팅:                                                │
│  - /api/auth/** → User API (8081)                      │
│  - /api/users/** → User API (8081)                     │
│  - /api/catalogs/** → Catalog API (8002)               │
│  - /api/items/** → Catalog API (8002)                  │
│  - /api/user-catalogs/** → Catalog API (8002)          │
│  - /api/upload/** → Catalog API (8002)                 │
└─────────────────────────────────────────────────────────┘
            │                           │
            ▼                           ▼
┌──────────────────────┐    ┌──────────────────────────┐
│   User API (8081)    │    │  Catalog API (8002)      │
│   Spring Boot 3.2.0  │    │  FastAPI + Docker        │
│                      │    │                          │
│  - JWT 발급          │    │  - JWT 검증              │
│  - 회원 관리         │    │  - 카탈로그 CRUD         │
│  - OAuth2 로그인     │    │  - 아이템 CRUD           │
│                      │    │  - 이미지 업로드         │
└──────────────────────┘    └──────────────────────────┘
            │                           │
            ▼                           ▼
┌──────────────────────┐    ┌──────────────────────────┐
│   H2 Database        │    │   SQLite Database        │
│   (인메모리)          │    │   (파일 기반)             │
│                      │    │                          │
│  - users 테이블      │    │  - catalogs 테이블       │
│                      │    │  - items 테이블          │
│                      │    │  - user_item_status      │
│                      │    │  - user_catalogs         │
└──────────────────────┘    └──────────────────────────┘
```

## 2. 서비스 간 역할

### 2.1 Flutter Client (프론트엔드)

**역할**: 사용자 인터페이스 제공 및 상태 관리

**주요 책임**:
- 사용자 입력 처리 및 검증
- GetX를 통한 반응형 상태 관리
- JWT 토큰 저장 및 자동 로그인
- API 호출 및 응답 처리
- 에러 핸들링 및 사용자 피드백

**기술 스택**:
- Flutter 3.x (Dart)
- GetX (상태 관리)
- HTTP 패키지 (API 통신)
- SharedPreferences (로컬 저장)

**포트**: 3000 (웹), 모바일 앱

### 2.2 User API (회원 관리)

**역할**: 사용자 인증 및 회원 정보 관리

**주요 책임**:
- OAuth2 소셜 로그인 처리 (Google, Naver)
- JWT 토큰 발급 및 검증
- 사용자 CRUD (생성, 조회, 수정, 삭제)
- 프로필 관리
- 회원 탈퇴 (Soft Delete)

**기술 스택**:
- Spring Boot 3.2.0
- Spring Security + OAuth2
- JWT (jjwt 라이브러리)
- JPA/Hibernate
- H2 Database (개발용)
- Lombok

**포트**: 8081

### 2.3 Catalog API (카탈로그 관리)

**역할**: 카탈로그 및 아이템 데이터 관리

**주요 책임**:
- 카탈로그 CRUD
- 아이템 CRUD 및 보유 상태 관리
- 사용자별 아이템 상태 추적
- 카탈로그 저장 (복사) 기능
- 실시간 수집률 계산
- 이미지 파일 업로드 및 서빙
- JWT 토큰 검증 (User API와 동일한 시크릿)

**기술 스택**:
- FastAPI (Python 3.13)
- SQLAlchemy (ORM)
- Pydantic (데이터 검증)
- PyJWT (JWT 검증)
- SQLite (개발용)
- Docker (컨테이너화)

**포트**: 8002

## 3. 주요 기술 스택

### 3.1 프론트엔드

| 기술 | 버전 | 용도 |
|------|------|------|
| Flutter | 3.x | 크로스 플랫폼 UI 프레임워크 |
| Dart | 3.x | 프로그래밍 언어 |
| GetX | 최신 | 상태 관리 및 라우팅 |
| HTTP | 최신 | REST API 통신 |
| SharedPreferences | 최신 | 로컬 데이터 저장 |

### 3.2 백엔드 - User API

| 기술 | 버전 | 용도 |
|------|------|------|
| Spring Boot | 3.2.0 | 웹 애플리케이션 프레임워크 |
| Java | 17 | 프로그래밍 언어 |
| Spring Security | 6.x | 인증 및 보안 |
| OAuth2 Client | 6.x | 소셜 로그인 |
| JWT (jjwt) | 0.12.x | JWT 토큰 생성/검증 |
| JPA/Hibernate | 6.x | ORM |
| H2 Database | 2.x | 인메모리 데이터베이스 |
| Lombok | 1.18.x | 코드 간소화 |
| Gradle | 8.x | 빌드 도구 |

### 3.3 백엔드 - Catalog API

| 기술 | 버전 | 용도 |
|------|------|------|
| FastAPI | 최신 | 웹 API 프레임워크 |
| Python | 3.13 | 프로그래밍 언어 |
| SQLAlchemy | 2.x | ORM |
| Pydantic | 2.x | 데이터 검증 |
| PyJWT | 2.x | JWT 토큰 검증 |
| SQLite | 3.x | 파일 기반 데이터베이스 |
| Uvicorn | 최신 | ASGI 서버 |
| Docker | 최신 | 컨테이너화 |

### 3.4 개발 도구

| 도구 | 용도 |
|------|------|
| Git | 버전 관리 |
| VSCode | 통합 개발 환경 |
| Postman | API 테스트 |
| Docker Desktop | 컨테이너 실행 |

## 4. 데이터 흐름 다이어그램

### 4.1 사용자 로그인 플로우

```
[Flutter App]
     │
     │ 1. POST /api/auth/dev-login
     │    { email, nickname }
     ▼
[User API - Spring Boot]
     │
     │ 2. 사용자 조회/생성
     │    UserService.findOrCreateDevUser()
     ▼
[H2 Database]
     │
     │ 3. 사용자 정보 반환
     ▼
[User API]
     │
     │ 4. JWT 토큰 생성
     │    JwtTokenProvider.createToken(userId)
     │    - Algorithm: HS256
     │    - Expiration: 24시간
     │    - Payload: { sub: userId }
     ▼
[Flutter App]
     │
     │ 5. 토큰 저장
     │    SharedPreferences.setString('jwt_token', token)
     │
     │ 6. AuthController 상태 업데이트
     │    _user.value = User.fromJson(response)
     │    _token.value = token
     ▼
[HomeScreen 이동]
```

### 4.2 카탈로그 조회 플로우

```
[Flutter App - HomeScreen]
     │
     │ 1. GET /api/user-catalogs/my-catalogs
     │    Authorization: Bearer {JWT}
     ▼
[Catalog API - FastAPI]
     │
     │ 2. JWT 토큰 검증
     │    get_current_user_id()
     │    - jwt.decode(token, SECRET_KEY, HS256)
     │    - user_id = payload['sub']
     ▼
[SQLite Database]
     │
     │ 3. 사용자 카탈로그 조회
     │    SELECT * FROM catalogs WHERE user_id = ?
     │
     │ 4. 각 카탈로그의 아이템 통계 계산
     │    - item_count: 전체 아이템 수
     │    - owned_count: 보유 아이템 수
     │    - completion_rate: (owned/total) * 100
     ▼
[Catalog API]
     │
     │ 5. JSON 응답 생성
     │    [{ catalog_id, title, completion_rate, ... }]
     ▼
[Flutter App]
     │
     │ 6. CatalogController 상태 업데이트
     │    _myCatalogs.value = catalogs
     │
     │ 7. UI 자동 갱신 (Obx 위젯)
     ▼
[HomeScreen 렌더링]
```

### 4.3 아이템 보유 상태 토글 플로우

```
[Flutter App - CatalogDetailScreen]
     │
     │ 1. 사용자가 체크박스 클릭
     │
     │ 2. PATCH /api/items/{itemId}/toggle-owned
     │    Authorization: Bearer {JWT}
     ▼
[Catalog API - FastAPI]
     │
     │ 3. JWT 검증 및 user_id 추출
     │
     │ 4. 아이템 조회 및 권한 확인
     │    - 카탈로그 소유자인지 검증
     ▼
[SQLite Database]
     │
     │ 5. user_item_status 조회/생성
     │    SELECT * FROM user_item_status
     │    WHERE user_id = ? AND item_id = ?
     │
     │ 6. owned 필드 토글
     │    UPDATE user_item_status
     │    SET owned = NOT owned
     ▼
[Catalog API]
     │
     │ 7. 업데이트된 아이템 정보 반환
     │    { item_id, owned: true, ... }
     ▼
[Flutter App]
     │
     │ 8. 아이템 목록 상태 업데이트
     │    items[index] = updatedItem
     │
     │ 9. 수집률 재계산
     │    ownedCount++
     │    completionRate = (ownedCount / itemCount) * 100
     │
     │ 10. UI 즉시 반영
     ▼
[CatalogDetailScreen 렌더링]
```

### 4.4 JWT 기반 마이크로서비스 통신

```
┌─────────────────────────────────────────────────────────┐
│                    Flutter App                          │
│  - JWT 토큰을 SharedPreferences에 저장                  │
│  - 모든 API 요청에 Authorization 헤더 자동 포함         │
└─────────────────────────────────────────────────────────┘
                    │                    │
        ┌───────────┘                    └───────────┐
        │                                            │
        ▼                                            ▼
┌──────────────────┐                      ┌──────────────────┐
│   User API       │                      │  Catalog API     │
│  (Spring Boot)   │                      │   (FastAPI)      │
│                  │                      │                  │
│ JWT 토큰 발급    │                      │ JWT 토큰 검증    │
│ - createToken()  │                      │ - jwt.decode()   │
│ - HS256          │                      │ - HS256          │
│ - 24시간 유효    │                      │ - user_id 추출   │
│                  │                      │                  │
│ 시크릿 키:       │◄────동일 키────────►│ 시크릿 키:       │
│ "jwt-secret" │                      │ "jwt-secret" │
└──────────────────┘                      └──────────────────┘
        │                                            │
        ▼                                            ▼
┌──────────────────┐                      ┌──────────────────┐
│   H2 Database    │                      │ SQLite Database  │
│  - users 테이블  │                      │ - catalogs       │
│                  │                      │ - items          │
│                  │                      │ - user_item_status│
│                  │                      │ - user_catalogs  │
└──────────────────┘                      └──────────────────┘

통신 흐름:
1. Flutter → User API: 로그인 요청
2. User API → Flutter: JWT 토큰 발급
3. Flutter → Catalog API: JWT 토큰 포함하여 API 호출
4. Catalog API: 동일한 시크릿 키로 토큰 검증
5. Catalog API: 토큰에서 user_id 추출
6. Catalog API: 해당 사용자 데이터만 처리
7. 사용자별 데이터 격리 완전 보장
```

## 5. 레이어 아키텍처

### 5.1 Flutter Client 레이어

```
┌─────────────────────────────────────────┐
│          Screens (UI Layer)             │
│  - splash_screen.dart                   │
│  - login_screen.dart                    │
│  - home_screen.dart                     │
│  - catalog_detail_screen.dart           │
│  - item_add_screen.dart                 │
│  - ...                                  │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Controllers (State Management)     │
│  - AuthController (GetX)                │
│  - CatalogController (GetX)             │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         Services (API Layer)            │
│  - ApiService                           │
│    * devLogin()                         │
│    * getMyCatalogs()                    │
│    * toggleItemOwned()                  │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         Models (Data Layer)             │
│  - User                                 │
│  - Catalog                              │
│  - Item                                 │
└─────────────────────────────────────────┘
```

### 5.2 User API (Spring Boot) 레이어

```
┌─────────────────────────────────────────┐
│      Controllers (REST API)             │
│  - AuthController                       │
│  - UserController                       │
│  - DevController                        │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Security (인증/인가)                │
│  - JwtAuthenticationFilter              │
│  - JwtTokenProvider                     │
│  - OAuth2SuccessHandler                 │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Services (비즈니스 로직)            │
│  - UserService                          │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Repositories (데이터 접근)          │
│  - UserRepository (JPA)                 │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Entities (데이터 모델)              │
│  - User                                 │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         H2 Database                     │
└─────────────────────────────────────────┘
```

### 5.3 Catalog API (FastAPI) 레이어

```
┌─────────────────────────────────────────┐
│      Routers (API Endpoints)            │
│  - catalogs.py                          │
│  - items.py                             │
│  - user_catalogs.py                     │
│  - upload.py                            │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Middleware (요청/응답 처리)         │
│  - LoggingMiddleware                    │
│  - CORSMiddleware                       │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Security (인증)                     │
│  - get_current_user_id()                │
│  - get_optional_user_id()               │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Schemas (데이터 검증)               │
│  - CatalogCreate, CatalogUpdate         │
│  - ItemCreate, ItemUpdate               │
│  - (Pydantic 모델)                      │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      CRUD (비즈니스 로직)                │
│  - catalog.py                           │
│  - item.py                              │
│  - user_catalog.py                      │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│      Models (데이터베이스 모델)          │
│  - CatalogDB                            │
│  - ItemDB                               │
│  - UserItemStatusDB                     │
│  - UserCatalogDB                        │
│  - (SQLAlchemy ORM)                     │
└─────────────────────────────────────────┘
                  ↓
┌─────────────────────────────────────────┐
│         SQLite Database                 │
└─────────────────────────────────────────┘
```

## 6. 배포 아키텍처

### 6.1 현재 (로컬 개발 환경)

```
┌─────────────────────────────────────────┐
│  개발자 로컬 머신 (macOS)                │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Flutter (포트 3000)             │   │
│  │  - flutter run -d chrome        │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  User API (포트 8081)            │   │
│  │  - ./gradlew bootRun            │   │
│  │  - H2 인메모리 DB                │   │
│  └─────────────────────────────────┘   │
│                                         │
│  ┌─────────────────────────────────┐   │
│  │  Catalog API (포트 8002)         │   │
│  │  - Docker 컨테이너               │   │
│  │  - SQLite 파일 DB                │   │
│  └─────────────────────────────────┘   │
└─────────────────────────────────────────┘
```

### 6.2 향후 (프로덕션 환경)

```
┌─────────────────────────────────────────────────────────┐
│                    AWS Cloud                            │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  CloudFront CDN                                 │   │
│  │  - Flutter 정적 파일 배포                        │   │
│  └─────────────────────────────────────────────────┘   │
│                        │                                │
│                        ▼                                │
│  ┌─────────────────────────────────────────────────┐   │
│  │  S3 Bucket                                      │   │
│  │  - Flutter 빌드 파일                             │   │
│  │  - 이미지 파일 저장                              │   │
│  └─────────────────────────────────────────────────┘   │
│                                                         │
│  ┌─────────────────────────────────────────────────┐   │
│  │  Application Load Balancer (ALB)                │   │
│  │  - /api/auth/** → User API                      │   │
│  │  - /api/users/** → User API                     │   │
│  │  - /api/catalogs/** → Catalog API               │   │
│  └─────────────────────────────────────────────────┘   │
│                │                        │               │
│                ▼                        ▼               │
│  ┌──────────────────────┐  ┌──────────────────────┐   │
│  │  EC2 (User API)      │  │  EC2 (Catalog API)   │   │
│  │  - Spring Boot JAR   │  │  - Docker Container  │   │
│  │  - Auto Scaling      │  │  - Auto Scaling      │   │
│  └──────────────────────┘  └──────────────────────┘   │
│                │                        │               │
│                ▼                        ▼               │
│  ┌──────────────────────┐  ┌──────────────────────┐   │
│  │  RDS (MySQL)         │  │  DynamoDB            │   │
│  │  - users 테이블      │  │  - catalogs 테이블   │   │
│  └──────────────────────┘  └──────────────────────┘   │
└─────────────────────────────────────────────────────────┘
```

## 7. 성능 및 확장성

### 7.1 성능 최적화

- **JWT Stateless 인증**: 세션 저장소 불필요, 서버 부하 최소화
- **데이터베이스 인덱스**: user_id, catalog_id에 인덱스 설정
- **실시간 계산**: 수집률을 매번 계산하여 최신 상태 보장
- **HTTP Keep-Alive**: 연결 재사용으로 네트워크 오버헤드 감소
- **Docker 컨테이너**: 빠른 배포 및 환경 일관성

### 7.2 확장성 전략

- **수평 확장**: 각 서비스를 독립적으로 스케일 아웃 가능
- **로드 밸런싱**: ALB를 통한 트래픽 분산
- **마이크로서비스**: 기능별 서비스 분리로 부분 확장 가능
- **캐싱 전략**: 향후 Redis 도입으로 응답 속도 개선
- **CDN 활용**: CloudFront로 정적 파일 전송 최적화

## 8. 보안 아키텍처

### 8.1 인증 보안

- **JWT 토큰**: HS256 알고리즘, 24시간 만료
- **HTTPS**: 프로덕션 환경에서 필수
- **토큰 저장**: 클라이언트에서 안전한 저장소 사용
- **OAuth2**: 신뢰할 수 있는 제공자 (Google, Naver)

### 8.2 데이터 보안

- **사용자별 격리**: JWT user_id로 데이터 접근 제어
- **SQL Injection 방지**: ORM 사용 (JPA, SQLAlchemy)
- **XSS 방지**: JSON 응답, 입력 데이터 검증
- **CORS 설정**: 프로덕션에서 특정 도메인만 허용

## 9. 모니터링 및 로깅

### 9.1 로깅 전략

- **User API**: Spring Boot 기본 로깅
- **Catalog API**: 모든 요청/응답 자동 로깅 (api_communication.log)
- **Flutter**: developer.log로 API 호출 추적

### 9.2 향후 모니터링

- **AWS CloudWatch**: 서버 메트릭 및 로그 수집
- **Sentry**: 에러 추적 및 알림
- **Prometheus + Grafana**: 실시간 모니터링 대시보드

# 상태 관리 문서

## 1. 상태 관리 개요

카탈로깅 앱은 **GetX** 패키지를 사용하여 반응형 상태 관리를 구현합니다.

### 1.1 GetX 선택 이유

- **간결한 문법**: 최소한의 보일러플레이트 코드
- **반응형 프로그래밍**: Rx 변수로 자동 UI 업데이트
- **의존성 주입**: Get.put()으로 전역 컨트롤러 관리
- **라우팅 통합**: Get.to()로 간편한 화면 전환
- **성능**: 효율적인 상태 업데이트

### 1.2 컨트롤러 구조

```
lib/controllers/
├── auth_controller.dart      # 인증 상태 관리
└── catalog_controller.dart   # 카탈로그 상태 관리
```

## 2. AuthController (인증 상태 관리)

### 2.1 역할

- JWT 토큰 관리
- 사용자 정보 관리
- 로그인/로그아웃 처리
- 자동 로그인

### 2.2 주요 상태 변수

```dart
class AuthController extends GetxController {
  // 반응형 상태 변수
  final Rx<User?> _user = Rx<User?>(null);           // 현재 사용자
  final RxString _token = ''.obs;                    // JWT 토큰
  final RxBool _isLoading = false.obs;               // 로딩 상태
  
  // Getter (외부 접근용)
  User? get user => _user.value;
  String get token => _token.value;
  bool get isLoading => _isLoading.value;
  bool get isAuthenticated => _token.value.isNotEmpty && _user.value != null;
}
```

### 2.3 주요 메서드

#### onInit()
```dart
@override
void onInit() {
  super.onInit();
  _loadToken();  // SharedPreferences에서 토큰 로드
}
```

#### devLogin()
```dart
Future<bool> devLogin(String email, String nickname) async {
  _isLoading.value = true;
  
  try {
    final response = await _apiService.devLogin(email, nickname);
    final token = response['accessToken'];
    
    await _saveToken(token);
    _token.value = token;
    _user.value = User.fromJson(response['user']);
    
    // CatalogController에도 토큰 전달
    final catalogController = Get.find<CatalogController>();
    catalogController.setApiToken(token);
    
    return true;
  } catch (e) {
    print('로그인 실패: $e');
    return false;
  } finally {
    _isLoading.value = false;
  }
}
```

#### logout()
```dart
Future<void> logout() async {
  await _deleteToken();
  _token.value = '';
  _user.value = null;
  
  // CatalogController 초기화
  final catalogController = Get.find<CatalogController>();
  catalogController.clear();
}
```

### 2.4 화면과의 관계

| 화면 | 사용하는 상태 | 사용하는 메서드 |
|------|--------------|----------------|
| SplashScreen | isAuthenticated | onInit() |
| LoginScreen | isLoading | devLogin() |
| HomeScreen | user | - |
| MyScreen | user | - |
| ProfileEditScreen | user | updateProfile() |

### 2.5 사용 예시

**LoginScreen에서 로그인**:
```dart
final authController = Get.find<AuthController>();

ElevatedButton(
  onPressed: () async {
    final success = await authController.devLogin(email, nickname);
    if (success) {
      Get.offAll(() => HomeScreen());
    }
  },
  child: Obx(() => authController.isLoading
      ? CircularProgressIndicator()
      : Text('로그인')),
)
```

**HomeScreen에서 사용자 정보 표시**:
```dart
final authController = Get.find<AuthController>();

Obx(() => Text('안녕하세요, ${authController.user?.nickname}님'))
```

## 3. CatalogController (카탈로그 상태 관리)

### 3.1 역할

- 카탈로그 목록 관리
- 아이템 목록 관리
- 수집률 계산
- API 호출 및 데이터 동기화

### 3.2 주요 상태 변수

```dart
class CatalogController extends GetxController {
  // 반응형 상태 변수
  final RxList<Catalog> _myCatalogs = <Catalog>[].obs;        // 내 카탈로그
  final RxList<Catalog> _publicCatalogs = <Catalog>[].obs;    // 공개 카탈로그
  final RxList<Item> _currentItems = <Item>[].obs;            // 현재 아이템 목록
  final RxBool _isLoading = false.obs;                        // 로딩 상태
  final Rx<Catalog?> _selectedCatalog = Rx<Catalog?>(null);  // 선택된 카탈로그
  
  // Getter
  List<Catalog> get myCatalogs => _myCatalogs;
  List<Catalog> get publicCatalogs => _publicCatalogs;
  List<Item> get currentItems => _currentItems;
  bool get isLoading => _isLoading.value;
  Catalog? get selectedCatalog => _selectedCatalog.value;
}
```

### 3.3 주요 메서드

#### loadMyCatalogs()
```dart
Future<void> loadMyCatalogs() async {
  _isLoading.value = true;
  
  try {
    final catalogs = await _apiService.getMyCatalogs();
    _myCatalogs.value = catalogs.map((c) => Catalog.fromJson(c)).toList();
  } catch (e) {
    print('카탈로그 로드 실패: $e');
  } finally {
    _isLoading.value = false;
  }
}
```

#### loadPublicCatalogs()
```dart
Future<void> loadPublicCatalogs({String? category}) async {
  _isLoading.value = true;
  
  try {
    final catalogs = await _apiService.getPublicCatalogs(category: category);
    _publicCatalogs.value = catalogs.map((c) => Catalog.fromJson(c)).toList();
  } catch (e) {
    print('공개 카탈로그 로드 실패: $e');
  } finally {
    _isLoading.value = false;
  }
}
```

#### loadItems()
```dart
Future<void> loadItems(String catalogId, {bool? owned}) async {
  _isLoading.value = true;
  
  try {
    final items = await _apiService.getItems(catalogId, owned: owned);
    _currentItems.value = items.map((i) => Item.fromJson(i)).toList();
  } catch (e) {
    print('아이템 로드 실패: $e');
  } finally {
    _isLoading.value = false;
  }
}
```

#### toggleItemOwned()
```dart
Future<void> toggleItemOwned(String itemId) async {
  try {
    final updatedItem = await _apiService.toggleItemOwned(itemId);
    
    // 현재 아이템 목록에서 업데이트
    final index = _currentItems.indexWhere((item) => item.itemId == itemId);
    if (index != -1) {
      _currentItems[index] = Item.fromJson(updatedItem);
    }
    
    // 선택된 카탈로그의 수집률 업데이트
    if (_selectedCatalog.value != null) {
      await loadCatalogDetail(_selectedCatalog.value!.catalogId);
    }
  } catch (e) {
    print('보유 상태 토글 실패: $e');
  }
}
```

#### saveCatalog()
```dart
Future<bool> saveCatalog(String catalogId) async {
  try {
    await _apiService.saveCatalog(catalogId);
    await loadMyCatalogs();  // 목록 새로고침
    return true;
  } catch (e) {
    print('카탈로그 저장 실패: $e');
    return false;
  }
}
```

### 3.4 화면과의 관계

| 화면 | 사용하는 상태 | 사용하는 메서드 |
|------|--------------|----------------|
| HomeScreen | myCatalogs, isLoading | loadMyCatalogs() |
| ExploreScreen | publicCatalogs, isLoading | loadPublicCatalogs() |
| CatalogDetailScreen | selectedCatalog, currentItems | loadCatalogDetail(), loadItems(), toggleItemOwned() |
| CatalogEditScreen | - | createCatalog(), updateCatalog() |
| ItemAddScreen | - | createItem() |
| ItemDetailScreen | - | updateItem(), deleteItem() |

### 3.5 사용 예시

**HomeScreen에서 카탈로그 목록 표시**:
```dart
final catalogController = Get.find<CatalogController>();

@override
void initState() {
  super.initState();
  catalogController.loadMyCatalogs();
}

Widget build(BuildContext context) {
  return Obx(() {
    if (catalogController.isLoading) {
      return CircularProgressIndicator();
    }
    
    return ListView.builder(
      itemCount: catalogController.myCatalogs.length,
      itemBuilder: (context, index) {
        final catalog = catalogController.myCatalogs[index];
        return CatalogCard(catalog: catalog);
      },
    );
  });
}
```

**CatalogDetailScreen에서 아이템 보유 상태 토글**:
```dart
final catalogController = Get.find<CatalogController>();

CheckboxListTile(
  value: item.owned,
  onChanged: (value) async {
    await catalogController.toggleItemOwned(item.itemId);
  },
  title: Text(item.name),
)
```

## 4. 컨트롤러 초기화

### 4.1 main.dart에서 전역 초기화

```dart
void main() {
  // GetX 컨트롤러 전역 등록
  Get.put(AuthController());
  Get.put(CatalogController());
  
  runApp(MyApp());
}
```

### 4.2 의존성 주입

```dart
// 어디서든 컨트롤러 접근 가능
final authController = Get.find<AuthController>();
final catalogController = Get.find<CatalogController>();
```

## 5. 상태 업데이트 흐름

### 5.1 로그인 흐름

```
1. LoginScreen: devLogin() 호출
   ↓
2. AuthController: API 호출
   ↓
3. AuthController: _token, _user 상태 업데이트
   ↓
4. CatalogController: setApiToken() 호출
   ↓
5. UI: Obx 위젯이 자동으로 재렌더링
   ↓
6. HomeScreen으로 이동
```

### 5.2 아이템 보유 상태 토글 흐름

```
1. CatalogDetailScreen: toggleItemOwned() 호출
   ↓
2. CatalogController: API 호출
   ↓
3. CatalogController: _currentItems 상태 업데이트
   ↓
4. CatalogController: loadCatalogDetail() 호출 (수집률 재계산)
   ↓
5. CatalogController: _selectedCatalog 상태 업데이트
   ↓
6. UI: Obx 위젯이 자동으로 재렌더링
   - 체크박스 상태 변경
   - 수집률 프로그레스 바 업데이트
```

## 6. 성능 최적화

### 6.1 불필요한 재렌더링 방지

**Obx 위젯 사용**:
```dart
// ✅ 좋은 예: 필요한 부분만 Obx로 감싸기
Column(
  children: [
    Text('고정 텍스트'),
    Obx(() => Text('${controller.count}')),  // 이 부분만 재렌더링
  ],
)

// ❌ 나쁜 예: 전체를 Obx로 감싸기
Obx(() => Column(
  children: [
    Text('고정 텍스트'),  // 불필요하게 재렌더링됨
    Text('${controller.count}'),
  ],
))
```

### 6.2 상태 캐싱

```dart
// 이미 로드된 데이터는 재로드하지 않음
Future<void> loadMyCatalogs({bool forceRefresh = false}) async {
  if (!forceRefresh && _myCatalogs.isNotEmpty) {
    return;  // 캐시된 데이터 사용
  }
  
  // API 호출...
}
```

### 6.3 Debouncing

```dart
// 검색 입력 시 과도한 API 호출 방지
Timer? _debounce;

void onSearchChanged(String query) {
  if (_debounce?.isActive ?? false) _debounce!.cancel();
  
  _debounce = Timer(const Duration(milliseconds: 500), () {
    searchCatalogs(query);
  });
}
```

## 7. 에러 처리

### 7.1 에러 상태 관리

```dart
class CatalogController extends GetxController {
  final RxString _errorMessage = ''.obs;
  
  String get errorMessage => _errorMessage.value;
  bool get hasError => _errorMessage.value.isNotEmpty;
  
  void clearError() {
    _errorMessage.value = '';
  }
}
```

### 7.2 에러 표시

```dart
Obx(() {
  if (controller.hasError) {
    return ErrorWidget(
      message: controller.errorMessage,
      onRetry: () {
        controller.clearError();
        controller.loadMyCatalogs();
      },
    );
  }
  
  return CatalogList();
})
```

## 8. 테스트

### 8.1 컨트롤러 단위 테스트

```dart
void main() {
  late AuthController authController;
  
  setUp(() {
    authController = AuthController();
  });
  
  test('로그인 성공 시 토큰과 사용자 정보 저장', () async {
    await authController.devLogin('test@example.com', '테스트');
    
    expect(authController.isAuthenticated, true);
    expect(authController.user, isNotNull);
    expect(authController.token, isNotEmpty);
  });
}
```

## 9. 모범 사례

### 9.1 Do's

- ✅ Obx 위젯으로 필요한 부분만 감싸기
- ✅ 컨트롤러에서 비즈니스 로직 처리
- ✅ 에러 처리 및 로딩 상태 관리
- ✅ 상태 변수는 private으로, getter로 접근
- ✅ 컨트롤러 간 의존성은 Get.find()로 주입

### 9.2 Don'ts

- ❌ UI 위젯에서 직접 API 호출
- ❌ 전체 화면을 Obx로 감싸기
- ❌ 컨트롤러에서 BuildContext 사용
- ❌ 상태 변수를 public으로 노출
- ❌ 컨트롤러에서 직접 화면 전환 (Get.to() 사용 자제)

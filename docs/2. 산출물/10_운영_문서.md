# 운영 문서 (Ops/Deployment)

## 1. 실행 절차

### 1.1 사전 요구사항

**개발 환경**:
- macOS (또는 Linux/Windows)
- Java 17 이상
- Python 3.13 이상
- Flutter 3.x
- Docker Desktop
- Git

### 1.2 User API 실행 (Spring Boot)

```bash
# 1. 프로젝트 디렉토리로 이동
cd be/user-api

# 2. 환경 변수 설정 (선택사항)
export JWT_SECRET=your-jwt-secret-key
export GOOGLE_CLIENT_ID=your-google-client-id
export GOOGLE_CLIENT_SECRET=your-google-client-secret

# 3. Gradle을 사용하여 실행
./gradlew bootRun

# 4. 서버 실행 확인
curl http://localhost:8081/api/test/health
```

**실행 결과**:
```
> Task :bootRun

  .   ____          _            __ _ _
 /\\ / ___'_ __ _ _(_)_ __  __ _ \ \ \ \
( ( )\___ | '_ | '_| | '_ \/ _` | \ \ \ \
 \\/  ___)| |_)| | | | | || (_| |  ) ) ) )
  '  |____| .__|_| |_|_| |_\__, | / / / /
 =========|_|==============|___/=/_/_/_/
 :: Spring Boot ::                (v3.2.0)

2025-11-08 10:00:00.000  INFO 12345 --- [main] c.c.u.UserApiApplication : Started UserApiApplication in 3.5 seconds
```

### 1.3 Catalog API 실행 (FastAPI + Docker)

```bash
# 1. 프로젝트 디렉토리로 이동
cd be/catalog-api

# 2. 환경 변수 파일 생성
cp .env.example .env

# 3. .env 파일 수정 (필요시)
# JWT_SECRET_KEY는 User API와 동일하게 설정

# 4. Docker 이미지 빌드
docker build -t catalog-api .

# 5. Docker 컨테이너 실행
docker run -d \
  --name catalog-api \
  -p 8002:8002 \
  -v $(pwd)/catalog.db:/app/catalog.db \
  -v $(pwd)/uploads:/app/uploads \
  catalog-api

# 6. 서버 실행 확인
curl http://localhost:8002/health

# 7. API 문서 확인
open http://localhost:8002/docs
```

**실행 결과**:
```
INFO:     Started server process [1]
INFO:     Waiting for application startup.
✅ SQLite 데이터베이스 초기화 완료
INFO:     Application startup complete.
INFO:     Uvicorn running on http://0.0.0.0:8002 (Press CTRL+C to quit)
```

### 1.4 Flutter 클라이언트 실행

```bash
# 1. 프로젝트 디렉토리로 이동
cd fe

# 2. 의존성 설치
flutter pub get

# 3. 웹 실행
flutter run -d chrome --web-port 3000

# 4. iOS 실행 (macOS만 가능)
flutter run -d ios

# 5. Android 실행
flutter run -d android

# 6. macOS 데스크톱 실행
flutter run -d macos
```

**실행 결과**:
```
Launching lib/main.dart on Chrome in debug mode...
Building application for the web...
lib/main.dart is being served at http://localhost:3000
```

## 2. 환경 변수 설정

### 2.1 User API 환경 변수

**application.yml**:
```yaml
jwt:
  secret: ${JWT_SECRET:your-jwt-secret-key}
  expiration: 86400000  # 24시간

spring:
  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${GOOGLE_CLIENT_ID:your-google-client-id}
            client-secret: ${GOOGLE_CLIENT_SECRET:your-google-client-secret}
          naver:
            client-id: ${NAVER_CLIENT_ID:your-naver-client-id}
            client-secret: ${NAVER_CLIENT_SECRET:your-naver-client-secret}
```

**환경 변수 설정 방법**:
```bash
# macOS/Linux
export JWT_SECRET=your-secret-key
export GOOGLE_CLIENT_ID=your-google-client-id
export GOOGLE_CLIENT_SECRET=your-google-client-secret

# Windows (PowerShell)
$env:JWT_SECRET="your-secret-key"
$env:GOOGLE_CLIENT_ID="your-google-client-id"
```

### 2.2 Catalog API 환경 변수

**.env 파일**:
```env
# 데이터베이스
DATABASE_URL=sqlite:///./catalog.db

# JWT 설정 (User API와 동일하게 설정)
JWT_SECRET_KEY=your-jwt-secret-key
JWT_ALGORITHM=HS256

# 파일 업로드
UPLOAD_DIR=./uploads

# CORS 설정
CORS_ORIGINS=*
CORS_CREDENTIALS=true
CORS_METHODS=*
CORS_HEADERS=*

# 로깅 설정
LOG_LEVEL=INFO
LOG_FILE=api_communication.log
LOG_FORMAT=%(asctime)s - %(name)s - %(levelname)s - %(message)s
```

**중요**: `JWT_SECRET_KEY`는 User API의 `jwt.secret`과 동일해야 합니다.

### 2.3 Flutter 환경 설정

**플랫폼별 API URL**:
```dart
// lib/services/api_service.dart
class ApiService {
  static String get userApiBaseUrl {
    if (kIsWeb) return 'http://localhost:8081';
    else if (Platform.isAndroid) return 'http://10.0.2.2:8081';
    else if (Platform.isIOS) return 'http://localhost:8081';
    else return 'http://localhost:8081';
  }
  
  static String get catalogApiBaseUrl {
    if (kIsWeb) return 'http://localhost:8002';
    else if (Platform.isAndroid) return 'http://10.0.2.2:8002';
    else if (Platform.isIOS) return 'http://localhost:8002';
    else return 'http://localhost:8002';
  }
}
```

## 3. 로그 및 모니터링

### 3.1 User API 로깅

**로그 레벨**:
```yaml
logging:
  level:
    com.cataloging.userapi: DEBUG
    org.springframework.security: DEBUG
```

**로그 위치**:
- 콘솔 출력
- 향후: 파일 로그 추가

**로그 예시**:
```
2025-11-08 10:00:00.000 DEBUG [http-nio-8081-exec-1] c.c.u.s.JwtTokenProvider : JWT 토큰 생성: userId=1
2025-11-08 10:00:01.000  INFO [http-nio-8081-exec-2] c.c.u.c.AuthController : 개발용 로그인 성공: email=test@example.com
```

### 3.2 Catalog API 로깅

**로그 설정**:
```python
# app/core/config.py
import logging

logging.basicConfig(
    level=settings.LOG_LEVEL,
    format=settings.LOG_FORMAT,
    handlers=[
        logging.FileHandler(settings.LOG_FILE),
        logging.StreamHandler()
    ]
)

logger = logging.getLogger("API_COMMUNICATION")
```

**로그 위치**:
- `api_communication.log` 파일
- 콘솔 출력

**로그 예시**:
```
2025-11-08 10:00:00 - API_COMMUNICATION - INFO - 요청: GET /api/user-catalogs/my-catalogs
2025-11-08 10:00:00 - API_COMMUNICATION - INFO - 사용자 ID: 1
2025-11-08 10:00:00 - API_COMMUNICATION - INFO - 응답: 200 OK (15ms)
```

### 3.3 Flutter 로깅

**로그 방법**:
```dart
import 'dart:developer' as developer;

// API 호출 전
developer.log('API 요청: GET /api/user-catalogs/my-catalogs');

// API 호출 후
developer.log('API 응답: 200 OK, 카탈로그 ${catalogs.length}개');

// 에러 발생 시
developer.log('API 에러: $e', error: e);
```

**로그 확인**:
- 웹: 브라우저 개발자 도구 콘솔
- 모바일: Android Studio / Xcode 콘솔

## 4. 배포 절차

### 4.1 로컬 개발 환경

**전체 시스템 시작**:
```bash
# 1. User API 시작 (터미널 1)
cd be/user-api && ./gradlew bootRun

# 2. Catalog API 시작 (터미널 2)
cd be/catalog-api && docker run -p 8002:8002 catalog-api

# 3. Flutter 시작 (터미널 3)
cd fe && flutter run -d chrome --web-port 3000
```

**전체 시스템 종료**:
```bash
# User API: Ctrl+C
# Catalog API: docker stop catalog-api
# Flutter: Ctrl+C
```

### 4.2 프로덕션 배포 (향후)

**User API (EC2)**:
```bash
# 1. JAR 파일 빌드
./gradlew build

# 2. EC2에 업로드
scp build/libs/user-api-0.0.1-SNAPSHOT.jar ec2-user@server:/app/

# 3. 서버에서 실행
ssh ec2-user@server
java -jar /app/user-api-0.0.1-SNAPSHOT.jar
```

**Catalog API (EC2 + Docker)**:
```bash
# 1. Docker 이미지 빌드
docker build -t catalog-api:latest .

# 2. Docker Hub에 푸시
docker tag catalog-api:latest username/catalog-api:latest
docker push username/catalog-api:latest

# 3. EC2에서 실행
ssh ec2-user@server
docker pull username/catalog-api:latest
docker run -d -p 8002:8002 username/catalog-api:latest
```

**Flutter (S3 + CloudFront)**:
```bash
# 1. 웹 빌드
flutter build web

# 2. S3에 업로드
aws s3 sync build/web/ s3://cataloging-app/

# 3. CloudFront 캐시 무효화
aws cloudfront create-invalidation --distribution-id DIST_ID --paths "/*"
```

## 5. 데이터베이스 관리

### 5.1 User API (H2)

**데이터베이스 접근**:
- URL: http://localhost:8081/h2-console
- JDBC URL: `jdbc:h2:mem:testdb`
- Username: `sa`
- Password: (비어있음)

**특징**:
- 인메모리 데이터베이스
- 서버 재시작 시 데이터 초기화
- 개발 및 테스트 용도

### 5.2 Catalog API (SQLite)

**데이터베이스 파일**:
- 위치: `be/catalog-api/catalog.db`
- 크기: 약 100KB (초기)

**백업**:
```bash
# 데이터베이스 백업
cp catalog.db catalog_backup_$(date +%Y%m%d).db

# 복원
cp catalog_backup_20251108.db catalog.db
```

**데이터베이스 초기화**:
```bash
# 데이터베이스 파일 삭제
rm catalog.db

# 서버 재시작 시 자동으로 재생성됨
```

## 6. 트러블슈팅

### 6.1 User API 문제

#### 문제: 서버가 시작되지 않음
```
Error: Could not find or load main class com.cataloging.userapi.UserApiApplication
```

**해결**:
```bash
# Gradle 캐시 정리
./gradlew clean

# 다시 빌드
./gradlew build

# 실행
./gradlew bootRun
```

#### 문제: JWT 토큰 검증 실패
```
401 Unauthorized: 유효하지 않은 토큰
```

**해결**:
1. User API와 Catalog API의 JWT 시크릿 키가 동일한지 확인
2. 토큰 만료 시간 확인 (24시간)
3. 토큰 형식 확인 (Bearer {token})

### 6.2 Catalog API 문제

#### 문제: Docker 컨테이너가 시작되지 않음
```
Error: Cannot start container
```

**해결**:
```bash
# 기존 컨테이너 제거
docker rm -f catalog-api

# 이미지 재빌드
docker build -t catalog-api .

# 다시 실행
docker run -p 8002:8002 catalog-api
```

#### 문제: 데이터베이스 연결 오류
```
sqlalchemy.exc.OperationalError: unable to open database file
```

**해결**:
```bash
# 데이터베이스 디렉토리 권한 확인
ls -la catalog.db

# 권한 수정
chmod 644 catalog.db

# 디렉토리 권한 확인
chmod 755 .
```

### 6.3 Flutter 문제

#### 문제: API 연결 실패
```
SocketException: Failed to connect to localhost:8081
```

**해결**:
1. User API와 Catalog API가 실행 중인지 확인
2. 포트 번호 확인 (8081, 8002)
3. 플랫폼별 URL 확인:
   - 웹: localhost
   - Android: 10.0.2.2
   - iOS: localhost

#### 문제: CORS 에러
```
Access to XMLHttpRequest has been blocked by CORS policy
```

**해결**:
```python
# Catalog API의 CORS 설정 확인
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # 개발 환경
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)
```

## 7. 모니터링

### 7.1 서버 상태 확인

**User API**:
```bash
# 헬스체크
curl http://localhost:8081/api/test/health

# 응답
{"status":"healthy","timestamp":"2025-11-08T10:00:00"}
```

**Catalog API**:
```bash
# 헬스체크
curl http://localhost:8002/health

# 응답
{"status":"healthy"}
```

### 7.2 로그 모니터링

**User API 로그**:
```bash
# 실시간 로그 확인
./gradlew bootRun | grep "ERROR"
```

**Catalog API 로그**:
```bash
# 파일 로그 확인
tail -f api_communication.log

# Docker 로그 확인
docker logs -f catalog-api
```

**Flutter 로그**:
```bash
# 웹 로그: 브라우저 개발자 도구 콘솔
# 모바일 로그: flutter logs
```

### 7.3 데이터베이스 모니터링

**User API (H2)**:
```bash
# H2 콘솔 접속
open http://localhost:8081/h2-console

# 사용자 수 확인
SELECT COUNT(*) FROM users;

# 최근 가입 사용자
SELECT * FROM users ORDER BY created_at DESC LIMIT 10;
```

**Catalog API (SQLite)**:
```bash
# SQLite CLI 접속
sqlite3 catalog.db

# 카탈로그 수 확인
SELECT COUNT(*) FROM catalogs;

# 사용자별 카탈로그 수
SELECT user_id, COUNT(*) FROM catalogs GROUP BY user_id;

# 수집률 통계
SELECT 
  c.title,
  COUNT(i.item_id) as total_items,
  SUM(CASE WHEN uis.owned = 1 THEN 1 ELSE 0 END) as owned_items
FROM catalogs c
LEFT JOIN items i ON c.catalog_id = i.catalog_id
LEFT JOIN user_item_status uis ON i.item_id = uis.item_id
GROUP BY c.catalog_id;
```

## 8. 성능 최적화

### 8.1 데이터베이스 최적화

**인덱스 확인**:
```sql
-- SQLite
SELECT * FROM sqlite_master WHERE type='index';

-- 인덱스 추가 (필요시)
CREATE INDEX idx_catalogs_user_id ON catalogs(user_id);
CREATE INDEX idx_items_catalog_id ON items(catalog_id);
CREATE INDEX idx_user_item_status_user_id ON user_item_status(user_id);
CREATE INDEX idx_user_item_status_item_id ON user_item_status(item_id);
```

### 8.2 API 응답 시간 측정

**Catalog API 미들웨어**:
```python
# app/core/middleware.py
import time

@app.middleware("http")
async def log_requests(request: Request, call_next):
    start_time = time.time()
    
    response = await call_next(request)
    
    process_time = time.time() - start_time
    logger.info(f"응답 시간: {process_time:.3f}초")
    
    return response
```

### 8.3 캐싱 전략 (향후)

**Redis 캐싱**:
```python
# 카탈로그 목록 캐싱
@cache(expire=300)  # 5분 캐시
async def get_user_catalogs(user_id: str):
    ...
```

## 9. 백업 및 복구

### 9.1 데이터베이스 백업

**자동 백업 스크립트**:
```bash
#!/bin/bash
# backup.sh

DATE=$(date +%Y%m%d_%H%M%S)

# SQLite 백업
cp be/catalog-api/catalog.db backups/catalog_$DATE.db

# 로그 백업
cp be/catalog-api/api_communication.log backups/log_$DATE.log

echo "백업 완료: $DATE"
```

**cron 설정** (매일 자정):
```bash
0 0 * * * /path/to/backup.sh
```

### 9.2 데이터 복구

```bash
# 백업 파일 목록 확인
ls -lh backups/

# 복구
cp backups/catalog_20251108_000000.db be/catalog-api/catalog.db

# 서버 재시작
docker restart catalog-api
```

## 10. 보안 점검

### 10.1 정기 점검 항목

- [ ] JWT 시크릿 키 강도 확인 (50자 이상)
- [ ] HTTPS 적용 확인 (프로덕션)
- [ ] CORS 설정 확인 (특정 도메인만 허용)
- [ ] 환경 변수 노출 확인 (.env 파일 Git 제외)
- [ ] 로그에 민감 정보 노출 확인
- [ ] 의존성 보안 업데이트 확인

### 10.2 보안 업데이트

```bash
# Spring Boot 의존성 업데이트
./gradlew dependencyUpdates

# Python 의존성 업데이트
pip list --outdated
pip install --upgrade package-name

# Flutter 의존성 업데이트
flutter pub outdated
flutter pub upgrade
```

## 11. 장애 대응

### 11.1 서비스 중단 시

1. **원인 파악**: 로그 확인
2. **임시 조치**: 서비스 재시작
3. **근본 원인 분석**: 로그 분석, 데이터베이스 확인
4. **영구 수정**: 코드 수정 및 배포

### 11.2 데이터 손실 시

1. **백업 확인**: 최신 백업 파일 확인
2. **복구**: 백업 파일로 복원
3. **데이터 검증**: 복구된 데이터 확인
4. **사용자 통지**: 손실 범위 및 복구 상황 안내

## 12. 운영 체크리스트

### 12.1 일일 점검

- [ ] 서버 상태 확인 (헬스체크)
- [ ] 로그 에러 확인
- [ ] 디스크 용량 확인
- [ ] API 응답 시간 확인

### 12.2 주간 점검

- [ ] 데이터베이스 백업 확인
- [ ] 보안 업데이트 확인
- [ ] 성능 지표 분석
- [ ] 사용자 피드백 검토

### 12.3 월간 점검

- [ ] 전체 시스템 백업
- [ ] 보안 감사
- [ ] 성능 최적화
- [ ] 문서 업데이트

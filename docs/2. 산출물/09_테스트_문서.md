# 테스트 문서 (Test Plan)

## 1. 테스트 전략 개요

카탈로깅 시스템의 테스트는 프론트엔드(Flutter), 백엔드(Spring Boot, FastAPI) 각 레이어에서 수행됩니다.

### 1.1 테스트 피라미드

```
        ┌─────────────┐
        │   E2E 테스트  │  (10%)
        │  (수동 테스트) │
        └─────────────┘
      ┌───────────────────┐
      │   통합 테스트       │  (30%)
      │ (API 테스트)       │
      └───────────────────┘
    ┌───────────────────────┐
    │     단위 테스트         │  (60%)
    │ (함수/클래스 테스트)    │
    └───────────────────────┘
```

## 2. 프론트엔드 테스트 (Flutter)

### 2.1 단위 테스트

**테스트 대상**:
- 모델 클래스 (User, Catalog, Item)
- 유틸리티 함수
- 데이터 변환 로직

**예시 - User 모델 테스트**:
```dart
// test/models/user_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:cataloging/models/user.dart';

void main() {
  group('User 모델 테스트', () {
    test('JSON에서 User 객체 생성', () {
      final json = {
        'id': 1,
        'email': 'test@example.com',
        'nickname': '테스트',
        'createdAt': '2025-11-08T10:00:00',
        'updatedAt': '2025-11-08T10:00:00',
      };
      
      final user = User.fromJson(json);
      
      expect(user.id, 1);
      expect(user.email, 'test@example.com');
      expect(user.nickname, '테스트');
    });
    
    test('User 객체를 JSON으로 변환', () {
      final user = User(
        id: 1,
        email: 'test@example.com',
        nickname: '테스트',
        createdAt: DateTime.parse('2025-11-08T10:00:00'),
        updatedAt: DateTime.parse('2025-11-08T10:00:00'),
      );
      
      final json = user.toJson();
      
      expect(json['id'], 1);
      expect(json['email'], 'test@example.com');
    });
  });
}
```

### 2.2 위젯 테스트

**테스트 대상**:
- 개별 위젯 렌더링
- 사용자 인터랙션
- 상태 변화에 따른 UI 업데이트

**예시 - LoginScreen 테스트**:
```dart
// test/screens/login_screen_test.dart
import 'package:flutter/material.dart';
import 'package:flutter_test/flutter_test.dart';
import 'package:cataloging/screens/login_screen.dart';

void main() {
  testWidgets('로그인 화면 렌더링 테스트', (WidgetTester tester) async {
    await tester.pumpWidget(MaterialApp(home: LoginScreen()));
    
    // 이메일 입력 필드 확인
    expect(find.byType(TextField), findsNWidgets(2));
    
    // 로그인 버튼 확인
    expect(find.text('로그인'), findsOneWidget);
  });
  
  testWidgets('로그인 버튼 클릭 테스트', (WidgetTester tester) async {
    await tester.pumpWidget(MaterialApp(home: LoginScreen()));
    
    // 이메일 입력
    await tester.enterText(
      find.byType(TextField).first,
      'test@example.com'
    );
    
    // 닉네임 입력
    await tester.enterText(
      find.byType(TextField).last,
      '테스트'
    );
    
    // 로그인 버튼 클릭
    await tester.tap(find.text('로그인'));
    await tester.pump();
    
    // 로딩 인디케이터 확인
    expect(find.byType(CircularProgressIndicator), findsOneWidget);
  });
}
```

### 2.3 통합 테스트

**테스트 대상**:
- 화면 간 네비게이션
- API 통신
- 전체 사용자 플로우

**예시 - 로그인 플로우 테스트**:
```dart
// integration_test/login_flow_test.dart
import 'package:flutter_test/flutter_test.dart';
import 'package:integration_test/integration_test.dart';
import 'package:cataloging/main.dart' as app;

void main() {
  IntegrationTestWidgetsFlutterBinding.ensureInitialized();
  
  testWidgets('로그인 후 홈 화면 이동', (WidgetTester tester) async {
    app.main();
    await tester.pumpAndSettle();
    
    // 로그인 화면 확인
    expect(find.text('로그인'), findsOneWidget);
    
    // 이메일 입력
    await tester.enterText(
      find.byType(TextField).first,
      'test@example.com'
    );
    
    // 닉네임 입력
    await tester.enterText(
      find.byType(TextField).last,
      '테스트'
    );
    
    // 로그인 버튼 클릭
    await tester.tap(find.text('로그인'));
    await tester.pumpAndSettle();
    
    // 홈 화면 확인
    expect(find.text('내 카탈로그'), findsOneWidget);
  });
}
```

## 3. 백엔드 테스트 (Spring Boot - User API)

### 3.1 단위 테스트

**테스트 대상**:
- Service 클래스
- JWT 토큰 생성/검증
- 비즈니스 로직

**예시 - JwtTokenProvider 테스트**:
```java
// src/test/java/com/cataloging/userapi/security/JwtTokenProviderTest.java
@SpringBootTest
class JwtTokenProviderTest {
    
    @Autowired
    private JwtTokenProvider jwtTokenProvider;
    
    @Test
    void JWT_토큰_생성_테스트() {
        // Given
        String userId = "1";
        
        // When
        String token = jwtTokenProvider.createToken(userId);
        
        // Then
        assertNotNull(token);
        assertTrue(token.length() > 0);
    }
    
    @Test
    void JWT_토큰_검증_테스트() {
        // Given
        String userId = "1";
        String token = jwtTokenProvider.createToken(userId);
        
        // When
        boolean isValid = jwtTokenProvider.validateToken(token);
        
        // Then
        assertTrue(isValid);
    }
    
    @Test
    void JWT_토큰에서_사용자_ID_추출_테스트() {
        // Given
        String userId = "1";
        String token = jwtTokenProvider.createToken(userId);
        
        // When
        String extractedUserId = jwtTokenProvider.getUserId(token);
        
        // Then
        assertEquals(userId, extractedUserId);
    }
}
```

### 3.2 통합 테스트

**테스트 대상**:
- REST API 엔드포인트
- 데이터베이스 연동
- 전체 요청-응답 흐름

**예시 - AuthController 테스트**:
```java
// src/test/java/com/cataloging/userapi/controller/AuthControllerTest.java
@SpringBootTest(webEnvironment = SpringBootTest.WebEnvironment.RANDOM_PORT)
@AutoConfigureMockMvc
class AuthControllerTest {
    
    @Autowired
    private MockMvc mockMvc;
    
    @Autowired
    private ObjectMapper objectMapper;
    
    @Test
    void 개발용_로그인_성공_테스트() throws Exception {
        // Given
        DevLoginRequest request = new DevLoginRequest();
        request.setEmail("test@example.com");
        request.setNickname("테스트");
        
        // When & Then
        mockMvc.perform(post("/api/auth/dev-login")
                .contentType(MediaType.APPLICATION_JSON)
                .content(objectMapper.writeValueAsString(request)))
                .andExpect(status().isOk())
                .andExpect(jsonPath("$.accessToken").exists())
                .andExpect(jsonPath("$.user.email").value("test@example.com"))
                .andExpect(jsonPath("$.user.nickname").value("테스트"));
    }
}
```

## 4. 백엔드 테스트 (FastAPI - Catalog API)

### 4.1 단위 테스트

**테스트 대상**:
- CRUD 함수
- 데이터 검증
- 비즈니스 로직

**예시 - Catalog CRUD 테스트**:
```python
# tests/test_catalog_crud.py
import pytest
from sqlalchemy.orm import Session
from app.crud import catalog
from app.schemas.catalog import CatalogCreate

def test_create_catalog(db: Session):
    # Given
    catalog_data = CatalogCreate(
        title="테스트 카탈로그",
        description="테스트 설명",
        category="피규어"
    )
    user_id = "1"
    
    # When
    created_catalog = catalog.create_catalog(db, catalog_data, user_id)
    
    # Then
    assert created_catalog.title == "테스트 카탈로그"
    assert created_catalog.user_id == user_id
    assert created_catalog.catalog_id is not None

def test_get_user_catalogs(db: Session):
    # Given
    user_id = "1"
    
    # When
    catalogs = catalog.get_user_catalogs(db, user_id)
    
    # Then
    assert isinstance(catalogs, list)
    for cat in catalogs:
        assert cat.user_id == user_id
```

### 4.2 API 테스트

**테스트 대상**:
- API 엔드포인트
- JWT 인증
- 요청/응답 검증

**예시 - Catalog API 테스트**:
```python
# tests/test_api_catalogs.py
from fastapi.testclient import TestClient
from app.main import app

client = TestClient(app)

def test_create_catalog():
    # Given
    token = "valid_jwt_token"
    catalog_data = {
        "title": "테스트 카탈로그",
        "description": "테스트 설명",
        "category": "피규어"
    }
    
    # When
    response = client.post(
        "/api/catalogs/",
        json=catalog_data,
        headers={"Authorization": f"Bearer {token}"}
    )
    
    # Then
    assert response.status_code == 201
    data = response.json()
    assert data["title"] == "테스트 카탈로그"
    assert data["catalog_id"] is not None

def test_get_my_catalogs():
    # Given
    token = "valid_jwt_token"
    
    # When
    response = client.get(
        "/api/user-catalogs/my-catalogs",
        headers={"Authorization": f"Bearer {token}"}
    )
    
    # Then
    assert response.status_code == 200
    data = response.json()
    assert isinstance(data, list)

def test_unauthorized_access():
    # Given
    catalog_data = {
        "title": "테스트 카탈로그",
        "description": "테스트 설명"
    }
    
    # When
    response = client.post("/api/catalogs/", json=catalog_data)
    
    # Then
    assert response.status_code == 401
```

## 5. Mock 전략

### 5.1 API Mock (Flutter)

**Mockito 사용**:
```dart
// test/mocks/mock_api_service.dart
import 'package:mockito/mockito.dart';
import 'package:cataloging/services/api_service.dart';

class MockApiService extends Mock implements ApiService {}

// 테스트에서 사용
void main() {
  late MockApiService mockApiService;
  
  setUp(() {
    mockApiService = MockApiService();
  });
  
  test('카탈로그 목록 조회 Mock', () async {
    // Given
    when(mockApiService.getMyCatalogs()).thenAnswer(
      (_) async => [
        {'catalog_id': '1', 'title': '테스트 카탈로그'}
      ]
    );
    
    // When
    final catalogs = await mockApiService.getMyCatalogs();
    
    // Then
    expect(catalogs.length, 1);
    expect(catalogs[0]['title'], '테스트 카탈로그');
  });
}
```

### 5.2 데이터베이스 Mock (FastAPI)

**pytest fixture 사용**:
```python
# tests/conftest.py
import pytest
from sqlalchemy import create_engine
from sqlalchemy.orm import sessionmaker
from app.models.database import Base

@pytest.fixture
def db():
    # 인메모리 SQLite 데이터베이스
    engine = create_engine("sqlite:///:memory:")
    Base.metadata.create_all(bind=engine)
    
    SessionLocal = sessionmaker(bind=engine)
    db = SessionLocal()
    
    yield db
    
    db.close()
```

## 6. 테스트 실행

### 6.1 Flutter 테스트

```bash
# 단위 테스트
flutter test

# 특정 테스트 파일
flutter test test/models/user_test.dart

# 커버리지 포함
flutter test --coverage

# 통합 테스트
flutter test integration_test/
```

### 6.2 Spring Boot 테스트

```bash
# 모든 테스트
./gradlew test

# 특정 테스트 클래스
./gradlew test --tests JwtTokenProviderTest

# 커버리지 리포트
./gradlew test jacocoTestReport
```

### 6.3 FastAPI 테스트

```bash
# 모든 테스트
pytest

# 특정 테스트 파일
pytest tests/test_catalog_crud.py

# 커버리지 포함
pytest --cov=app tests/

# 상세 출력
pytest -v
```

## 7. 테스트 커버리지 목표

| 레이어 | 목표 커버리지 | 현재 상태 |
|--------|--------------|-----------|
| Flutter Models | 80% | 미구현 |
| Flutter Controllers | 70% | 미구현 |
| Spring Boot Services | 80% | 미구현 |
| Spring Boot Controllers | 70% | 미구현 |
| FastAPI CRUD | 80% | 미구현 |
| FastAPI Routers | 70% | 미구현 |

## 8. 통합 테스트 시나리오

### 8.1 사용자 등록 및 카탈로그 생성

```
1. POST /api/auth/dev-login
   - 새 사용자 생성
   - JWT 토큰 발급

2. GET /api/users/me
   - 사용자 정보 조회
   - 토큰 검증

3. POST /api/catalogs/
   - 카탈로그 생성
   - user_id 자동 설정

4. GET /api/user-catalogs/my-catalogs
   - 생성된 카탈로그 확인
   - 수집률 0% 확인
```

### 8.2 아이템 추가 및 보유 상태 관리

```
1. POST /api/items/
   - 아이템 생성
   - owned=False 기본값

2. GET /api/items/catalog/{catalog_id}
   - 아이템 목록 조회
   - 보유 상태 확인

3. PATCH /api/items/{item_id}/toggle-owned
   - 보유 상태 토글
   - owned=True로 변경

4. GET /api/user-catalogs/my-catalogs
   - 수집률 업데이트 확인
   - completion_rate 증가 확인
```

## 9. 성능 테스트

### 9.1 부하 테스트

**도구**: Apache JMeter, Locust

**시나리오**:
- 동시 사용자 100명
- 카탈로그 조회 API 호출
- 평균 응답 시간 < 200ms

### 9.2 스트레스 테스트

**시나리오**:
- 점진적으로 사용자 수 증가
- 시스템 한계점 파악
- 에러율 < 1%

## 10. 테스트 자동화

### 10.1 CI/CD 파이프라인

```yaml
# .github/workflows/test.yml
name: Test

on: [push, pull_request]

jobs:
  flutter-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: subosito/flutter-action@v2
      - run: flutter pub get
      - run: flutter test
  
  spring-boot-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v2
        with:
          java-version: '17'
      - run: ./gradlew test
  
  fastapi-test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.13'
      - run: pip install -r requirements.txt
      - run: pytest
```

## 11. 테스트 모범 사례

### 11.1 Do's

- ✅ 테스트는 독립적으로 실행 가능해야 함
- ✅ 테스트 이름은 명확하고 설명적으로
- ✅ Given-When-Then 패턴 사용
- ✅ 테스트 데이터는 최소한으로
- ✅ 실패 시 명확한 에러 메시지

### 11.2 Don'ts

- ❌ 테스트 간 의존성 생성
- ❌ 프로덕션 데이터베이스 사용
- ❌ 하드코딩된 시간/날짜
- ❌ 외부 서비스 직접 호출
- ❌ 테스트에서 랜덤 값 사용
